<!DOCTYPE html>
<!-- _layouts/distill.html --><html>
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>معیاری بهتر برای زمان اذان و روزه | Arash  Golmohammadi</title>
    <meta name="author" content="Arash  Golmohammadi">
    <meta name="description" content="یک روش کمی برای حل مشکل روزه‌های طولانی">


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous">

    <!-- Bootstrap Table -->
    <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.3/dist/bootstrap-table.min.css">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&amp;display=swap" rel="stylesheet">
    
    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light">

    
    <!-- Sidebar Table of Contents -->
    <link href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css" rel="stylesheet">
    

    <!-- Styles -->
    
    <link rel="shortcut icon" href="/assets/img/logo.svg">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://arashgmn.github.io/blog/2021/fasting/">
    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark">

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    


    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    <!-- Distill js -->
    <script src="/assets/js/distillpub/template.v2.js"></script>
    <script src="/assets/js/distillpub/transforms.v2.js"></script>
    <script src="/assets/js/distillpub/overrides.js"></script>
    
  </head>

  <body>
<d-front-matter>
    <script async type="text/json">{
      "title": "معیاری بهتر برای زمان اذان و روزه",
      "description": "یک روش کمی برای حل مشکل روزه‌های طولانی",
      "published": "April 25, 2021",
      "authors": [
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script>
  </d-front-matter>

  

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Arash </span>Golmohammadi</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/publications/">publications</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/projects/">projects</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/repositories/">repositories</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/cv/">cv</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/teaching/">teaching</a>
              </li>
              <li class="nav-item dropdown ">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus</a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/publications/">publications</a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="/projects/">projects</a>
                </div>
              </li>

              <!-- Toogle theme mode -->
              <li class="toggle-container">
                <button id="light-toggle" title="Change theme">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Scrolling Progress Bar -->
      <progress id="progress" value="0">
        <div class="progress-container">
          <span class="progress-bar"></span>
        </div>
      </progress>
    </header>


    <!-- Content -->
    <div class="post distill" dir="rtl" align="right">

      <d-title>
        <h1>معیاری بهتر برای زمان اذان و روزه</h1>
        <p>یک روش کمی برای حل مشکل روزه‌های طولانی</p>
      </d-title>

      <d-byline></d-byline>

      <d-article>
        <d-contents>
          <nav class="l-text figcaption">
          <h3>Contents</h3>
            <div><a href="#"></a></div>
            
          </nav>
        </d-contents>

        <h1 id="مقدمه">مقدمه</h1>
<p>طول مدت روزه گرفتن در ماه رمضان، به خصوص برای عرض‌های بسیار شمالی و جنوبی گاها به ۲۴ ساعت می‌رسد. این نشان می‌دهد که معیار فعلی روزه گرفتن، که بر اساس اوقات شرعی (محلی) تنظیم شده، نمی‌تواند برای تمامی کره‌ زمین کاربردی باشد. 
برای مثال، من در ادامه نمودار میزان زمان روزه‌گرفتن در روزهای مختلف سال برای تمامی عرض‌های جغرافیایی شمالی را رسم می‌کنم ( عرض‌های جنوبی نموداری مشابه خواهند داشت با یک اختلاف شش ماهه).</p>

<p>برای محاسبه‌ی این نمودار از معیارهای تعیین اوقات شرعی (مطابق تعریف مرکز ژئوفیزیک دانشگاه تهران) استفاده شده است:</p>

<ul>
  <li>
<strong>اذان صبح</strong> وقتی است که خورشید ۱۷.۷ درجه زیر افق باشد</li>
  <li>
<strong>اذان مغرب</strong> وقتی است که خورشید ۴.۵ درجه زیر افق باشد</li>
</ul>

<p>هم‌چنین، مختصات خورشید در نیمه‌شب خورشیدی میانگین در مدار صفر درجه برای تمامی روزهای سال ۲۰۲۱ از نرم‌افزار  آزاد <a href="http://stellarium.org/" rel="external nofollow noopener" target="_blank">استلاریوم</a> استخراج شده است. مقادیر معادله‌ی زمان برای سال ۲۰۲۱ نیز از <a href="http://www.ppowers.com/EoT.htm" rel="external nofollow noopener" target="_blank">این جا</a> برداشته شده است.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">numpy</span> <span class="kn">import</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="n">arcsin</span><span class="p">,</span> <span class="n">arccos</span><span class="p">,</span> <span class="n">arctan</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">matplotlib.cm</span> <span class="kn">import</span> <span class="n">get_cmap</span>

<span class="kn">from</span> <span class="n">astropy.coordinates</span> <span class="kn">import</span> <span class="n">Angle</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># loading files: sun coordinates &amp; Equation of time
</span><span class="k">def</span> <span class="nf">sun_date_parser</span><span class="p">(</span><span class="n">date_string</span><span class="p">):</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">date_string</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)).</span><span class="nf">normalize</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">eot_date_parser</span><span class="p">(</span><span class="n">date_string</span><span class="p">):</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="sh">'</span><span class="s">2020 </span><span class="sh">'</span> <span class="o">+</span> <span class="n">date_string</span><span class="p">)).</span><span class="nf">normalize</span><span class="p">()</span>

<span class="n">sun</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">data/ephemeris.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">Date and Time</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s"> RA (J2000)</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s"> Dec (J2000)</span><span class="sh">'</span><span class="p">],</span>
                  <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">Date and Time</span><span class="sh">'</span><span class="p">],</span> <span class="n">date_parser</span><span class="o">=</span><span class="n">sun_date_parser</span><span class="p">,</span>
                  <span class="n">index_col</span><span class="o">=</span><span class="sh">'</span><span class="s">Date and Time</span><span class="sh">'</span><span class="p">)</span>

<span class="n">eot</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">data/EoT_2021.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">EoT</span><span class="sh">'</span><span class="p">],</span>
                  <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">],</span> <span class="n">date_parser</span><span class="o">=</span><span class="n">eot_date_parser</span><span class="p">,</span>
                  <span class="n">index_col</span><span class="o">=</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Data cleaning
</span>
<span class="c1"># renaming the columns and index and converting to degree
</span><span class="n">sun</span> <span class="o">=</span> <span class="n">sun</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">mapper</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span><span class="nf">zip</span><span class="p">([</span><span class="sh">'</span><span class="s"> RA (J2000)</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s"> Dec (J2000)</span><span class="sh">'</span><span class="p">],</span> <span class="p">[</span><span class="sh">'</span><span class="s">ra</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dec</span><span class="sh">'</span><span class="p">])),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sun</span><span class="p">.</span><span class="n">ra</span> <span class="o">=</span> <span class="nc">Angle</span><span class="p">(</span><span class="n">sun</span><span class="p">.</span><span class="n">ra</span><span class="p">).</span><span class="n">deg</span>
<span class="n">sun</span><span class="p">.</span><span class="n">dec</span> <span class="o">=</span> <span class="nc">Angle</span><span class="p">(</span><span class="n">sun</span><span class="p">.</span><span class="n">dec</span><span class="p">).</span><span class="n">deg</span>

<span class="c1"># only need to convert to timedelta object
</span><span class="n">eot</span> <span class="o">=</span> <span class="n">eot</span><span class="p">.</span><span class="n">EoT</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">eot</span><span class="p">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nf">round</span><span class="p">(</span><span class="nf">float</span><span class="p">(</span><span class="n">eot</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">m</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># minute
</span>    <span class="n">s</span> <span class="o">=</span> <span class="nf">round</span><span class="p">(</span><span class="nf">float</span><span class="p">(</span><span class="n">eot</span><span class="p">[</span><span class="n">idx</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># second
</span>    <span class="n">eot</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Some global variables
</span><span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span> <span class="c1"># deg to rad
</span><span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-8</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="sh">'</span><span class="s">2021-01-01</span><span class="sh">'</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sh">'</span><span class="s">2021-12-31</span><span class="sh">'</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="sh">'</span><span class="s">D</span><span class="sh">'</span><span class="p">)</span>
<span class="n">cool_places</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">Equator</span><span class="sh">'</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="sh">'</span><span class="s">Mecca</span><span class="sh">'</span><span class="p">:[</span><span class="mf">21.3891</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
               <span class="sh">'</span><span class="s">Morning at Midnight</span><span class="sh">'</span><span class="p">:[</span><span class="mf">48.85</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>\
               <span class="sh">'</span><span class="s">Night at Midnight</span><span class="sh">'</span><span class="p">:[</span><span class="mf">62.05</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
               <span class="sh">'</span><span class="s">Pole</span><span class="sh">'</span><span class="p">:[</span><span class="mi">90</span><span class="p">,</span><span class="mi">0</span><span class="p">],}</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">phi</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Just for coloring based on latitude
    </span><span class="sh">"""</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="nf">get_cmap</span><span class="p">(</span><span class="sh">'</span><span class="s">viridis</span><span class="sh">'</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">phi</span><span class="o">/</span><span class="mf">90.</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">cmap</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_sun</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">landa</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Computes the sun coordinates at midnight of the given dates for
    location with longitude landa. The sun daily coordinates are 
    sampled at GMT midnight. The correct this on a non-zero longitude
    we linearly interpolate the sun coordinates between days using
    central finite difference.
    </span><span class="sh">"""</span>
    
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">([</span><span class="n">sun</span><span class="p">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">date</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># index of the date
</span>    <span class="n">idxn</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nf">len</span><span class="p">(</span><span class="n">sun</span><span class="p">)</span> 
    <span class="n">idxp</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nf">len</span><span class="p">(</span><span class="n">sun</span><span class="p">)</span> 
    
    <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">sun</span><span class="p">.</span><span class="n">ra</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">values</span><span class="p">,</span> <span class="n">sun</span><span class="p">.</span><span class="n">dec</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">values</span> <span class="c1"># at GMT
</span>    <span class="n">ran</span><span class="p">,</span> <span class="n">decn</span> <span class="o">=</span> <span class="n">sun</span><span class="p">.</span><span class="n">ra</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idxn</span><span class="p">].</span><span class="n">values</span><span class="p">,</span> <span class="n">sun</span><span class="p">.</span><span class="n">dec</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idxn</span><span class="p">].</span><span class="n">values</span> <span class="c1"># at GMT
</span>    <span class="n">rap</span><span class="p">,</span> <span class="n">decp</span> <span class="o">=</span> <span class="n">sun</span><span class="p">.</span><span class="n">ra</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idxp</span><span class="p">].</span><span class="n">values</span><span class="p">,</span> <span class="n">sun</span><span class="p">.</span><span class="n">dec</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idxp</span><span class="p">].</span><span class="n">values</span> <span class="c1"># at GMT
</span>
    <span class="c1"># interpolate
</span>    <span class="n">dec</span> <span class="o">=</span> <span class="n">dec</span> <span class="o">-</span> <span class="p">(</span><span class="n">decp</span> <span class="o">-</span> <span class="n">decn</span><span class="p">)</span><span class="o">/</span><span class="mf">720.</span> <span class="o">*</span> <span class="p">(</span><span class="n">landa</span> <span class="o">-</span> <span class="mi">180</span><span class="p">)</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">ra</span> <span class="o">-</span> <span class="p">(</span><span class="n">rap</span> <span class="o">-</span> <span class="n">ran</span><span class="p">)</span><span class="o">/</span><span class="mf">720.</span> <span class="o">*</span> <span class="p">(</span><span class="n">landa</span> <span class="o">-</span> <span class="mi">180</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span>


<span class="k">def</span> <span class="nf">compute_day_time</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">dates</span><span class="p">,</span> <span class="n">a_set</span><span class="o">=-</span><span class="mf">4.5</span><span class="p">,</span> <span class="n">a_rise</span><span class="o">=-</span><span class="mf">17.7</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    compute the day_time, given the altitutes of rising and setting.
    
    Assumptions:
        1. The sun is fixed during one solar day
        2. The sun coordinates changes linearly from the one midnight (of UTC) to the other
        3. When the rise/set altitude requirements are not met, the hour angle is set to +/-12h.
    
    a_set:    the altitude of center of the sun at maqrib azaan
    a_rize:   the altitude of center of the sun at morning azaan
    dates:    the dates overwhich the fasting duration is desired (list of Timestaps)
    coords:   location coordinates in degree
    </span><span class="sh">"""</span>
    <span class="n">phi</span><span class="p">,</span> <span class="n">landa</span> <span class="o">=</span> <span class="n">coords</span>
    <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="nf">get_sun</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">landa</span><span class="p">)</span>
    
    <span class="n">cos_Hrise</span> <span class="o">=</span> <span class="p">(</span><span class="nf">sin</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">a_rise</span><span class="p">)</span> <span class="o">-</span>
                 <span class="nf">sin</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">dec</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="nf">cos</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">dec</span><span class="p">))</span>
    <span class="n">cos_Hset</span> <span class="o">=</span> <span class="p">(</span><span class="nf">sin</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">a_set</span><span class="p">)</span> <span class="o">-</span> <span class="nf">sin</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">dec</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span> <span class="o">*</span>
                                                                 <span class="nf">cos</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">dec</span><span class="p">))</span>

    <span class="c1"># cap the cos values
</span>    <span class="n">cos_Hset</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">cos_Hset</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">cos_Hrise</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">cos_Hrise</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>

    <span class="n">Hrise</span> <span class="o">=</span> <span class="nf">arccos</span><span class="p">(</span><span class="n">cos_Hrise</span><span class="p">)</span>
    <span class="n">Hset</span> <span class="o">=</span> <span class="nf">arccos</span><span class="p">(</span><span class="n">cos_Hset</span><span class="p">)</span>

    <span class="nf">return </span><span class="p">(</span><span class="n">Hset</span> <span class="o">+</span> <span class="n">Hrise</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="mf">15.</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># visualizing model 0
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">gca</span><span class="p">()</span>

<span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">90</span><span class="p">,</span><span class="nf">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">phi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">):</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="mf">0.0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nf">compute_day_time</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>
    <span class="n">arr</span><span class="p">[</span><span class="n">phi</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">phi</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span> <span class="sh">'</span><span class="s">:</span><span class="sh">'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">cool_places</span><span class="p">.</span><span class="nf">keys</span><span class="p">():</span>
    <span class="n">coord_</span> <span class="o">=</span> <span class="n">cool_places</span><span class="p">[</span><span class="n">place</span><span class="p">]</span>
    <span class="n">t_</span> <span class="o">=</span> <span class="nf">compute_day_time</span><span class="p">(</span><span class="n">coord_</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>   <span class="c1"># equator
</span>    <span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">t_</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="nf">color_phi</span><span class="p">(</span><span class="n">coord_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="n">place</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            
<span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">()</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">fasting duration (h)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">);</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xlim</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
</code></pre></div></div>

<p><img src="output_6_0.png" alt="png"></p>

<p>این نمودار چند رفتار مشخصه دارد:</p>

<ul>
  <li>طول زمان روزه گرفتن در استوا تقریبا ثابت (و برابر با ۱۳.۵ ساعت) است</li>
  <li>هر چه عرض افزایش می‌یابد، تغییرات زمان روزه گرفتن بیشتر می‌شود. به طور مثال ساکنین شهر مکه، روزه‌هایی به طول ۱۲ تا ۱۵ ساعت را تجربه می‌کنند. اما ساکنین شهر مشهد، از ۱۱ ساعت تا نزدیک یه ۱۷ ساعت روزه می‌گیرند.</li>
  <li>در عرض‌های شمالی‌تر، اذان صبح بسیار زود و اذان مغرب بسیار دیر گفته خواهد شد. به طوری که از عرض ۴۹ درجه شمالی به بعد، در روزهای خاصی از سال، نیمه‌شب شرعی و اذان صبح بر هم منطبق می‌شوند. بالاتر از عرض ۶۲ درجه، در این روزهای خاص، حتی اذان مغرب هم در نیمه‌شب رخ می‌دهد؛ و این به معنای آنست که طول روزه گرفتن با طول شبانه روز برابر می‌شود.</li>
  <li>در (حالت حدی) قطب شمال، از کمی قبل از آغاز بهار تا کمی بعد از پایان تابستان، در تمامی طول روز باید روزه گرفته شود. در تمامی زمستان طول زمان روزه صفر است. و در زمان گذار بین پاییز به زمستان و زمستان به بهار، مجموعا نزدیک یه ۲.۵ ماه، ۱۲ ساعت باید روزه گرفته شود.</li>
</ul>

<p>به طور معادل، می‌توان به احتمال وجود روزه‌ی بلندمدت (مثلا بیش از ۱۷ ساعت) در طول سال برای هر عرض جغرافیایی نگاه کرد. البته باید توجه کرد که به دلیل انحنای زمین، یک بازه‌ی یک درجه‌ای عرض، در عرض‌های جغرافیایی بالا، مساحت کوچکتری از کره‌ی زمین را در مقایسه با همان نوار یک درجه‌ای در عرض‌های استوایی‌تر می‌پوشاند. نمودار زیر،این احتمال را با تصحیح اثر انحنای زمین نشان می‌دهد.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">surf</span> <span class="o">=</span> <span class="p">[</span><span class="nf">cos</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">)]</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="nb">long</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">]:</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">arr</span><span class="o">&gt;=</span><span class="nb">long</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">).</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">arr</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">surf</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="o">-</span><span class="mi">89</span><span class="p">,</span><span class="mi">90</span><span class="p">),(</span><span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">((</span><span class="n">prob</span><span class="p">[:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">prob</span><span class="p">))),</span>\
             <span class="n">label</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Fasting more than {} h</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nb">long</span><span class="p">),</span>\
             <span class="n">color</span> <span class="o">=</span> <span class="sh">'</span><span class="s">g</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">(</span><span class="nb">long</span><span class="o">-</span><span class="mi">15</span><span class="p">)</span><span class="o">/</span><span class="mf">7.</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">(Surface-scaled) probability of long fasting over the year</span><span class="sh">'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">latitude</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">(Surface-scaled) Probability</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="sh">'</span><span class="s">best</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">grid</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="output_8_0.png" alt="png"></p>

<p>پیام نمودار بالا آن است که از عر جغرافیایی ۴۰ به بعد، روزه‌های طولانی مستمرا بیشتر می‌شوند. با توجه به این واقعیت، به نظرم می‌توان به راهکاری برای <em>تصحیح</em> معیار اذان در عرض‌های بالا رسید که در ادامه توضیحش می‌دهم.</p>

<h1 id="یک-ایدهی-ساده">یک ایده‌ی ساده</h1>
<p>ساده، این ارتفاع خورشید است که زمان اذان را مشخص می‌کند. اما موقعیت خورشید در هر لحظه، به مکان وابسته است و همین وابستگی است که چنین تغییراتی را سبب می‌شوند. البته این معیار بسیار طبیعی است. شب و روز بودن، بدون شک، تنها با موقعیت خورشید است که تعیین می‌شوند. اما ارتفاع خورشید در آسمان، تنها سنجه از گذر زمان از شب به روز  نیست. مثلا می‌توان (کاملا قرارداری) نیمی از ۲۴ ساعت شبانه‌روز را شب و نیمی دیگر را روز نامید. البته طبیعی است که  تمامی نقاط زمین، هم‌زمان روز یا شب نخواهند بود. با این حال طول شب یا روز یکسانی خواهند داشت. این که روز (یا شب) کی آغاز شود، صرفا به طول جغرافیایی محل مربوط خواهد بود، به طور ساده به این که شهر در قسمت شرقی زمین است یا قسمت غربی آن. اما این زمان آغاز، طول روز و شب را عوض نخواهد کرد. یک انتخاب طبیعی آن است که 
شروع نیمه‌ی روز طوری باشد که ظهر (بلندترین موقعیت خورشید در یک روز) دقیقا در وسط این آن اتفاق بیافتد.</p>

<p>نکته‌ی جالب این که همین ایده‌ی ساده، سبب می‌شود که در محل‌هایی، روز قبل از طلوع خورشید (رسما) آغاز شود یا شب بسیار پس از غروب خورشید. یا برعکس، می‌توان با وجود خورشید در آسمان شب داشت، و روزی بدون خورشید. اما تمامی این حالات را می‌توان با یک تصویر ذهنی ساده از کره‌ی زمین ِگردان در فضا توضیح داد: شب و روز نه با خورشید، بلکه با توجه به این که زمین چند درجه حول محورش چرخیده تعریف می‌شود.</p>

<p>اهل فن به این زاویه‌ی چرخش زمین را زاویه ساعتی می‌گویند. در اصل کافی است که ما برای زاویه‌ی ساعتی آغاز شب و روز را تعریف کنیم. مثلا بگوییم که دوست داریم روز، ساعت ۶ بامداد و شب ۱۸ شروع شوند. با این وصف، طول روز در همه‌جا ۱۲=۶-۱۸ خواهد بود. به همین سادگی!</p>

<p>اما بگذارید ببینیم که با این تعریف، در حین آغاز و پایان روز، ارتفاع خورشید در جاهای مختلف چقدر است.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">compute_alt_from_ha</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">dates</span><span class="p">,</span> <span class="n">h1</span><span class="o">=-</span><span class="mi">6</span><span class="o">*</span><span class="mi">15</span><span class="p">,</span> <span class="n">h2</span><span class="o">=+</span><span class="mi">6</span><span class="o">*</span><span class="mi">15</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    compute the altitudes given hour angles of rising and setting
    
    Assumptions:
        1. The sun is fixed during one solar day
        2. The sun coordinates changes linearly from the one midnight (of UTC) to the other
        3. When the rise/set altitude requirements are not met, the hour angle is set to +/-12h.
    
    a_set:    the altitude of center of the sun at maqrib azaan
    a_rize:   the altitude of center of the sun at morning azaan
    dates:    the dates overwhich the fasting duration is desired (list of Timestaps)
    coords:   location coordinates in degree
    </span><span class="sh">"""</span>
    <span class="n">phi</span><span class="p">,</span> <span class="n">landa</span> <span class="o">=</span> <span class="n">coords</span>
    <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="nf">get_sun </span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">landa</span><span class="p">)</span>
    
    <span class="n">sin_a1</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">dec</span><span class="p">)</span><span class="o">+</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">dec</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">h1</span><span class="p">)</span>
    <span class="n">sin_a2</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">dec</span><span class="p">)</span><span class="o">+</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">dec</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">h2</span><span class="p">)</span>
    
    <span class="c1"># cap the cos values
</span>    <span class="n">sin_a1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">sin_a1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">sin_a2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">sin_a2</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>
    
    <span class="n">a1</span> <span class="o">=</span> <span class="nf">arcsin</span><span class="p">(</span><span class="n">sin_a1</span><span class="p">)</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="nf">arcsin</span><span class="p">(</span><span class="n">sin_a2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a1</span><span class="o">/</span><span class="n">r</span> <span class="p">,</span> <span class="n">a2</span><span class="o">/</span><span class="n">r</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">phis</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">)</span>
<span class="k">for</span> <span class="n">phi</span> <span class="ow">in</span> <span class="n">phis</span><span class="p">:</span>
    <span class="n">coord_</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="mf">0.0</span>
    <span class="n">a1</span><span class="p">,</span><span class="n">a2</span> <span class="o">=</span> <span class="nf">compute_alt_from_ha</span><span class="p">(</span><span class="n">coord_</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span> <span class="sh">'</span><span class="s">:</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span> <span class="sh">'</span><span class="s">:</span><span class="sh">'</span><span class="p">)</span>


<span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">cool_places</span><span class="p">.</span><span class="nf">keys</span><span class="p">():</span>
    <span class="n">coord_</span> <span class="o">=</span> <span class="n">cool_places</span><span class="p">[</span><span class="n">place</span><span class="p">]</span>
    <span class="n">a1</span><span class="p">,</span><span class="n">a2</span> <span class="o">=</span> <span class="nf">compute_alt_from_ha</span><span class="p">(</span><span class="n">coord_</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">coord_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="n">place</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">coord_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="n">place</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">hlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ax</span><span class="p">.</span><span class="nf">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">ax</span><span class="p">.</span><span class="nf">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_xlim</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Sun elevation at the start of the Day</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Sun elevation at the srart of the Night</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="output_11_0.png" alt="png"></p>

<p>این دو نمودار نشان می‌دهد که در بهار و تابستان، (در عرض‌های شمالی) شب، با وجود خورشید در آسمان آغاز شده و تمام می‌شود. به طور مشابه، در زمستان و پاییز، روز وقتی شروع (و تمام) می‌شود که خورشید هنوز طلوع (و غروب) نکرده است. تنها استثنا استواست که همواره طلوع و غروب با آغاز روز و شب همزمانند.</p>

<h1 id="ادغام">ادغام</h1>
<p>معیار بالا چندان معیار جالبی نیست. چون بر خلاف معیار سابق که تنها عرض‌های شمالی را درگیر می‌کرد، این تمامی عرض‌ها را مناثر می‌کند و این در حالی است که عرض‌های استوایی، اساسا مشکلی با معیار عرفی فعلی ندارند!</p>

<p>یک راه حل مناسب ادغام این دو روش است به نحوی که در عرض‌های پایین (مثلا تا ۵۰ درجه) شب و روز مطابق معیار طبیعیشان (طلوع و غروب) تعیین شوند و به مرور، با رفتن به عرض‌های قطبی‌تر معیار دوم پر رنگ‌تر شود.</p>

<p>من این ادغام را با میانگین‌گیری وزن‌دار روی زاویه‌ساعتی خورشید بر اساس دو معیار انجام می‌دهم. به طور دقیق‌تر با تعریف یک تابع وزن$w$ (که به عرض جغرافیایی) مرتبط است، زاویه‌ی ساعتی مدل ادغامی را محاسبه می‌کنم:</p>

\[H = w(\phi) H_1 + [1-w(\phi)] H_2\]

<p>توجه کنید که هر دو معیار فعلی اوقات شرعی (۱) و معیار اخیر (۲)، که بر پایه‌ی زاویه‌ی چرخش زمین تعریف شد، دو پارامتر آزاد دارند. پارامترهای آزاد معیار اوقات شرعی، ارتفاع‌های خورشید در لحظه‌ی اذان صبح و مغرب هستند. اما پارامترهای معیار دیگر زاویه‌های ساعتی خورشید (میزان زاویه‌ی چرخش زمین نسبت به ظهر) در آغاز و پایان روز. هر چند که من به پارامترهای معیار ۱ دست نخواهم برد، اما توجه به این نکته ضروری است که ما این اعداد را از مرکز ژئوفیزیک دانشگاه تهران استخراج کرده‌ایم و اصولا می‌توان با روش‌های دیگری هم لحظه‌ی اذان را تعریف کرد. مثلا نگاه کنید به <a href="">این</a>.</p>

<p>از سوی مقابل، پارمترهای آزاد معیار ۲ تماما در اختیار ما هستند. در قبل ساعات ۶ و ۱۸ به عنوان زمان شروع و پایان روز انتخاب شد. اما می‌توان انتخاب‌های بهتری داشت که با مذهب سازگارتر هم باشند. مثلا پیشنهاد من، انتخاب حد بالا و پایین زاویه ساعتی در شهر مکه در زمان اذان صبح و مغرب است:</p>

<p>\(\cos H_{rise} = [\sin (a_{rise}) - \sin \phi \sin \epsilon] / (\cos \phi \cos \epsilon)\)
\(\cos H_{set} = [\sin (a_{set}) - \sin \phi \sin \epsilon] / (\cos \phi \cos \epsilon)\)</p>

\[H_{rise} = -8.11425\  hour \hspace{1cm} H_{set} = 7.01112\ hour\]

<p>این اعداد، نمودار ارتفاع خورشید در آغاز و پایان روز را بدین شکل تغییر خواهد داد؛ که نشان می‌دهد از استوا تا عرض نزدیک به ۵۵ درجه، اذان صبح (یا شروع روز) همواره قبل از طلوع خورشید خواهد بود. اما در عرض‌های شمالی‌تر، در برخی زمان‌ها در سال، روز پس از طلوع خورشید آغاز می‌شود. از سمت مقابل، اذان مغرب (پایان روز) برای عرض‌های بیش از ۳۰ درجه، در برخی روز‌ها در زمان بالای افق بودن خورشید رخ می‌دهد.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">h1</span><span class="p">,</span><span class="n">h2</span><span class="o">=-</span><span class="mf">8.11425</span><span class="o">*</span><span class="mf">15.</span><span class="p">,</span><span class="o">+</span><span class="mf">7.01112</span><span class="o">*</span><span class="mf">15.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">phi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">):</span>
    <span class="n">coord_</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="mf">0.0</span>
    <span class="n">a1</span><span class="p">,</span><span class="n">a2</span> <span class="o">=</span> <span class="nf">compute_alt_from_ha</span><span class="p">(</span><span class="n">coord_</span><span class="p">,</span> <span class="n">dates</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span> <span class="sh">'</span><span class="s">:</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span> <span class="sh">'</span><span class="s">:</span><span class="sh">'</span><span class="p">)</span>


<span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">cool_places</span><span class="p">.</span><span class="nf">keys</span><span class="p">():</span>
    <span class="n">coord_</span> <span class="o">=</span> <span class="n">cool_places</span><span class="p">[</span><span class="n">place</span><span class="p">]</span>
    <span class="n">a1</span><span class="p">,</span><span class="n">a2</span> <span class="o">=</span> <span class="nf">compute_alt_from_ha</span><span class="p">(</span><span class="n">coord_</span><span class="p">,</span> <span class="n">dates</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">coord_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="n">place</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">coord_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="n">place</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">hlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ax</span><span class="p">.</span><span class="nf">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">ax</span><span class="p">.</span><span class="nf">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_xlim</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Sun elevation at the start of the Day</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Sun elevation at the srart of the Night</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="output_14_0.png" alt="png"></p>

<p>برای تابع وزن، ما به دنبال تابعی هستیم که به نرمی و یکنوا از مقدار ۱ در استوا به مقدار ۰ در قطب تغییر کند. من به دلخواه (و برای سادگی) تابعی خطی را انتخاب کرده‌ام با ذکر این نکته که بی‌نهایت تابع دیگر می‌توان انتخاب کرد.</p>

\[w(\phi) = 1-\frac{|\phi|}{90}\]

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">blend_models</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">dates</span><span class="p">,</span> <span class="n">no_blend</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">a_set</span><span class="o">=-</span><span class="mf">4.5</span><span class="p">,</span> <span class="n">a_rise</span><span class="o">=-</span><span class="mf">17.7</span><span class="p">,</span> <span class="n">h_rise</span><span class="o">=-</span><span class="mf">8.11425</span><span class="o">*</span><span class="mi">15</span><span class="p">,</span> <span class="n">h_set</span><span class="o">=+</span><span class="mf">7.01112</span><span class="o">*</span><span class="mi">15</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    compute the day_time.
    
    Assumptions:
        1. The sun is fixed during one solar day
        2. The sun coordinates changes linearly from the one midnight (of UTC) to the other
        3. When the rise/set altitude requirements are not met, the hour angle is set to +/-12h.
    
    a_set:    the altitude of center of the sun at maqrib azaan
    a_rize:   the altitude of center of the sun at morning azaan
    dates:    the dates overwhich the fasting duration is desired (list of Timestaps)
    coords:   location coordinates in degree
    no_blend: turns off blending and yield the default model
    
    outputs:
    
    t:             duration of fasting (h)
    a_set_blend:   blended altitude of sun at set (degree)
    a_rise_blend:  blended altitude of sun at rise (degree)
    H_set_blend:   blended hour angle of setting (h)
    H_rise_blend:  blended hour angle of rising (h)
    </span><span class="sh">"""</span>
    <span class="n">phi</span><span class="p">,</span> <span class="n">landa</span> <span class="o">=</span> <span class="n">coords</span>
    <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="nf">get_sun </span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">landa</span><span class="p">)</span>
    
    <span class="c1"># let's compute the default model (model 0) h and a in set and rise
</span>    <span class="n">cos_h_rise_0</span> <span class="o">=</span> <span class="p">(</span><span class="nf">sin</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">a_rise</span><span class="p">)</span> <span class="o">-</span>
                 <span class="nf">sin</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">dec</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="nf">cos</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">dec</span><span class="p">))</span>
    <span class="n">cos_h_set_0</span> <span class="o">=</span> <span class="p">(</span><span class="nf">sin</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">a_set</span><span class="p">)</span> <span class="o">-</span> <span class="nf">sin</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="nf">sin</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">dec</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span> <span class="o">*</span>
                                                                 <span class="nf">cos</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">dec</span><span class="p">))</span>
    <span class="c1"># cap the cos values
</span>    <span class="n">cos_h_set_0</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">cos_h_set_0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">cos_h_rise_0</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">cos_h_rise_0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>

    <span class="n">h_rise_0</span> <span class="o">=</span> <span class="o">-</span><span class="nf">arccos</span><span class="p">(</span><span class="n">cos_h_rise_0</span><span class="p">)</span><span class="o">/</span><span class="n">r</span>
    <span class="n">h_set_0</span> <span class="o">=</span> <span class="nf">arccos</span><span class="p">(</span><span class="n">cos_h_set_0</span><span class="p">)</span><span class="o">/</span><span class="n">r</span>

    <span class="c1"># blend_factor
</span>    <span class="k">if</span> <span class="n">no_blend</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nf">abs</span><span class="p">(</span><span class="n">phi</span><span class="o">/</span><span class="mf">90.</span><span class="p">))</span> <span class="c1"># cos(r* abs(phi))
</span>
    <span class="n">H_rise_blend</span> <span class="o">=</span> <span class="n">h_rise_0</span> <span class="o">*</span> <span class="n">w</span> <span class="o">+</span> <span class="n">h_rise</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">w</span><span class="p">)</span>
    <span class="n">H_set_blend</span> <span class="o">=</span> <span class="n">h_set_0</span> <span class="o">*</span> <span class="n">w</span> <span class="o">+</span> <span class="n">h_set</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">w</span><span class="p">)</span>
    
    <span class="c1"># compute a at blendded h
</span>    <span class="n">sin_a_set_blend</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">dec</span><span class="p">)</span><span class="o">+</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">dec</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">H_set_blend</span><span class="p">)</span>
    <span class="n">sin_a_rise_blend</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">dec</span><span class="p">)</span><span class="o">+</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span><span class="o">*</span> <span class="n">dec</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">H_rise_blend</span><span class="p">)</span>
    
    <span class="c1"># cap the cos values
</span>    <span class="n">sin_a_set_blend</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">sin_a_set_blend</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>
    <span class="n">sin_a_rise_blend</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">sin_a_rise_blend</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>
    
    <span class="n">a_set_blend</span> <span class="o">=</span> <span class="nf">arcsin</span><span class="p">(</span><span class="n">sin_a_set_blend</span><span class="p">)</span><span class="o">/</span><span class="n">r</span>
    <span class="n">a_rise_blend</span> <span class="o">=</span> <span class="nf">arcsin</span><span class="p">(</span><span class="n">sin_a_rise_blend</span><span class="p">)</span><span class="o">/</span><span class="n">r</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">H_set_blend</span> <span class="o">-</span> <span class="n">H_rise_blend</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">15.</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">a_set_blend</span><span class="p">,</span> <span class="n">a_rise_blend</span><span class="p">,</span> <span class="n">H_set_blend</span><span class="p">,</span> <span class="n">H_rise_blend</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplot_mosaic</span><span class="p">(</span>
    <span class="sh">"""</span><span class="s">
    AA
    BC
    </span><span class="sh">"""</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> 

<span class="n">phis</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">)</span>
<span class="n">arr_</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="nf">len</span><span class="p">(</span><span class="n">phis</span><span class="p">),</span><span class="nf">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">phi</span> <span class="ow">in</span> <span class="n">phis</span><span class="p">:</span>
    <span class="n">coord_</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="mf">0.0</span>
    <span class="n">t_</span><span class="p">,</span> <span class="n">a1_</span><span class="p">,</span> <span class="n">a2_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nf">blend_models</span><span class="p">(</span><span class="n">coord_</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>
    <span class="n">arr_</span><span class="p">[</span><span class="n">phi</span><span class="p">,:]</span><span class="o">=</span><span class="n">t_</span>
    <span class="n">axs</span><span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">t_</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span> <span class="sh">'</span><span class="s">:</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">a1_</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span> <span class="sh">'</span><span class="s">:</span><span class="sh">'</span><span class="p">)</span> <span class="c1"># set
</span>    <span class="n">axs</span><span class="p">[</span><span class="sh">'</span><span class="s">C</span><span class="sh">'</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">a2_</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span> <span class="sh">'</span><span class="s">:</span><span class="sh">'</span><span class="p">)</span> <span class="c1"># rise
</span>

<span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">cool_places</span><span class="p">.</span><span class="nf">keys</span><span class="p">():</span>
    <span class="n">coord_</span> <span class="o">=</span> <span class="n">cool_places</span><span class="p">[</span><span class="n">place</span><span class="p">]</span>
    <span class="n">t_</span><span class="p">,</span> <span class="n">a1_</span> <span class="p">,</span><span class="n">a2_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nf">blend_models</span><span class="p">(</span><span class="n">coord_</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">t_</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">coord_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="n">place</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,)</span>
    <span class="n">axs</span><span class="p">[</span><span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">a1_</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">coord_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="n">place</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="sh">'</span><span class="s">C</span><span class="sh">'</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">a2_</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="nf">color_phi</span><span class="p">(</span><span class="n">coord_</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">label</span><span class="o">=</span><span class="n">place</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_xlim</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">id_</span><span class="o">!=</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">:</span> 
        <span class="n">ax</span><span class="p">.</span><span class="nf">hlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ax</span><span class="p">.</span><span class="nf">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">ax</span><span class="p">.</span><span class="nf">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        
<span class="n">axs</span><span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Fasting duration (h)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Sun elevation at Maqrib Azaan</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="sh">'</span><span class="s">C</span><span class="sh">'</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Sun elevation at Morning Azaan</span><span class="sh">'</span><span class="p">);</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="output_17_0.png" alt="png"></p>

<p>ادغام دو معیار به سه نمودار بالا منتج می‌شود. نمودار اول نشان می‌دهد که زمان روزه برای تمامی عرض‌ها در تمامی طول سال بین ۱۳ تا کمی کمتر از ۱۸ساعت تغییر خواهد کرد. به علاوه بیشترین زمان روزه مربوط به عرض‌های میانی است و به طور ویژه، در قطب طول مدت روزه همواره کمی بیش از ۱۵ ساعت خواهد بود.</p>

<p>نمودارهای دوم و سوم هم نشان می‌دهند که مشابه با عرف فعلی، زمان اذان مغرب در بیشتر عرض‌های جغرافیایی استوایی  همواره پس از غروب خورشید خواهد بود. زمان اذان صبح امااز عرض حدودا ۴۵ درجه به بعد، گاهی اوقات پس از طلوع خورشید است.</p>

<h1 id="اثر-رویکرد-پیشنهادی">اثر رویکرد پیشنهادی</h1>
<p>طول زمان روزه گرفتن و تغییرات آن برای هر عرض و در طول سال در نمودارهای زیر رسم شده است. با وجود این که عرض‌های  میانی (همان‌هایی که بیشتری مشکل را با روزه‌های بلندمدت دارند) بیشترین زمان روزه‌داری را مطابق این رویکرد دارند، همزمان، بیشترین کاهش درطول زمان روزداری را هم تجربه می‌کنند، به طوری که حتی در طولانی‌ترین روزه‌ها، کمی‌ کمتر از ۱۸ ساعت روزه باید گرفته شود.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">),)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">sca</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">pcolor</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">),</span> <span class="n">arr_</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">viridis</span><span class="sh">'</span><span class="p">,</span><span class="n">shading</span><span class="o">=</span><span class="sh">'</span><span class="s">auto</span><span class="sh">'</span><span class="p">)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
<span class="n">cb</span><span class="p">.</span><span class="nf">set_label</span><span class="p">(</span><span class="sh">"</span><span class="s">Fasting duration (h)</span><span class="sh">"</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">sca</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">pcolor</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">),</span> <span class="n">arr_</span><span class="o">-</span><span class="n">arr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">RdBu</span><span class="sh">'</span><span class="p">,</span><span class="n">shading</span><span class="o">=</span><span class="sh">'</span><span class="s">auto</span><span class="sh">'</span><span class="p">)</span>
<span class="n">cb</span><span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
<span class="n">cb</span><span class="p">.</span><span class="nf">set_label</span><span class="p">(</span><span class="sh">"</span><span class="s">Fasting duration difference (h)</span><span class="sh">"</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">)</span>

<span class="c1"># ax.subtitle('Fasting duration difference (h)')
</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">latitude</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="output_20_0.png" alt="png"></p>

<p>نمودار زیر نشان می‌دهد که احتمال روزه‌های بلند، تماما حذف شده است و این رویکرد ادغامی، علی‌رقم سادگی‌اش، کاراست.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">surf</span> <span class="o">=</span> <span class="p">[</span><span class="nf">cos</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">)]</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="nb">long</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">]:</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">arr_</span><span class="o">&gt;=</span><span class="nb">long</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">).</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">arr_</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">surf</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="o">-</span><span class="mi">89</span><span class="p">,</span><span class="mi">90</span><span class="p">),(</span><span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">((</span><span class="n">prob</span><span class="p">[:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">prob</span><span class="p">))),</span>\
             <span class="n">label</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Fasting more than {} h</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nb">long</span><span class="p">),</span>\
             <span class="n">color</span> <span class="o">=</span> <span class="sh">'</span><span class="s">g</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">(</span><span class="nb">long</span><span class="o">-</span><span class="mi">15</span><span class="p">)</span><span class="o">/</span><span class="mf">7.</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">(Surface-scaled) Probability of long fasting over the year</span><span class="sh">'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">latitude</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">(Surface-scaled) probability</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="sh">'</span><span class="s">best</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">grid</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="output_22_0.png" alt="png"></p>

<h1 id="میانگین-ساعات-روزه-گرفتن-برای-کشورها">میانگین ساعات روزه گرفتن برای کشورها</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">timezonefinder</span> <span class="kn">import</span> <span class="n">TimezoneFinder</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="k">def</span> <span class="nf">find_local_noon</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">dates</span><span class="p">,</span> <span class="n">eot</span><span class="p">,</span> <span class="n">split_from_noon</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">no_blend</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    finds the civil time of local noon, morning and
    maqrib for all the days in the year. Day time saving
    are taken into account. However, as the sun coordinates
    are sampled, an extention of 1-minute from both sides
    (morning and maqrib) is recommended, when used in 
    practice.
    
    two dataframes will be produced with the same content 
    but different format. the first one, shows the morning,
    noon, and maqrib times, as well as duration in HH:MM:SS
    format as string. The second one yields the same in 
    float (in hours).
    
    Equations:
    ==========
    
    EoT = HA - HAMS
    LMT = 12 + HAMS
    CT = LMT - longitude + timezone
    
    Notes:
    ======
    - longitude &gt; 0 for eastern locations
    - timezone &gt; 0 for eastern locations
    
    Example for noon (HA = 0)
    ======
    CT_noon = -EoT + 12 - longitude + timezone
    CT_morn = CT_noon - duration/2
    CT_maqr = CT_noon + duration/2
    </span><span class="sh">"""</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">aset</span><span class="p">,</span> <span class="n">arise</span><span class="p">,</span> <span class="n">hset</span><span class="p">,</span> <span class="n">hrise</span> <span class="o">=</span> <span class="nf">blend_models</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">dates</span><span class="p">,</span> <span class="n">no_blend</span><span class="o">=</span><span class="n">no_blend</span><span class="p">)</span>
    
    <span class="c1"># timezone name
</span>    <span class="n">tzn</span> <span class="o">=</span> <span class="nc">TimezoneFinder</span><span class="p">().</span><span class="nf">timezone_at</span><span class="p">(</span><span class="n">lng</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lat</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
    
    <span class="c1"># offsets
</span>    <span class="c1">## equation of time
</span>    <span class="n">offset_eot</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">e</span><span class="p">.</span><span class="nf">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">3600.</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eot</span><span class="p">.</span><span class="n">values</span><span class="p">])</span>
    <span class="c1">## longitude
</span>    <span class="n">offset_lng</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">ones_like</span><span class="p">(</span><span class="n">offset_eot</span><span class="p">)</span><span class="o">*</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">15</span>
    <span class="c1">## timezone
</span>    <span class="n">offset_tz</span> <span class="o">=</span> <span class="p">[</span><span class="n">date</span><span class="p">.</span><span class="nf">utcoffset</span><span class="p">().</span><span class="nf">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span>\
                 <span class="n">dates</span><span class="p">.</span><span class="nf">tz_localize</span><span class="p">(</span><span class="n">tzn</span><span class="p">,</span> <span class="n">nonexistent</span><span class="o">=</span><span class="sh">'</span><span class="s">shift_backward</span><span class="sh">'</span><span class="p">)]</span>
    <span class="c1"># TODO: On dates on which DST is activated or deactivated ambiguity
</span>    <span class="c1">#       in time will occur. Depending on the season, shift in 
</span>    <span class="c1">#       forward or backward is needed!!!
</span>    
    
    <span class="n">t_noon</span> <span class="o">=</span> <span class="o">-</span> <span class="n">offset_eot</span> <span class="o">-</span> <span class="n">offset_lng</span> <span class="o">+</span> <span class="n">offset_tz</span> <span class="o">+</span> <span class="mi">12</span>
    
    <span class="k">if</span> <span class="n">split_from_noon</span><span class="p">:</span>
        <span class="n">t_start</span> <span class="o">=</span> <span class="n">t_noon</span> <span class="o">-</span> <span class="n">t</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">t_end</span> <span class="o">=</span> <span class="n">t_noon</span> <span class="o">+</span> <span class="n">t</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t_start</span> <span class="o">=</span> <span class="n">t_noon</span> <span class="o">+</span> <span class="n">hrise</span><span class="o">/</span><span class="mf">15.</span>
        <span class="n">t_end</span> <span class="o">=</span> <span class="n">t_noon</span> <span class="o">+</span> <span class="n">hset</span><span class="o">/</span><span class="mf">15.</span>
        
    <span class="n">df_num</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">dates</span><span class="p">,</span> 
                          <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">start</span><span class="sh">'</span><span class="p">:</span><span class="n">t_start</span><span class="p">,</span><span class="sh">'</span><span class="s">noon</span><span class="sh">'</span><span class="p">:</span><span class="n">t_noon</span><span class="p">,</span> <span class="sh">'</span><span class="s">end</span><span class="sh">'</span><span class="p">:</span><span class="n">t_end</span><span class="p">,</span><span class="sh">'</span><span class="s">duration</span><span class="sh">'</span><span class="p">:</span><span class="n">t</span><span class="p">},</span>
                          <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="n">t_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%H:%M:%S</span><span class="sh">"</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">gmtime</span><span class="p">(</span><span class="n">start</span><span class="o">*</span><span class="mi">3600</span><span class="p">))</span> <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">t_start</span><span class="p">]</span>
    <span class="n">t_noon</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%H:%M:%S</span><span class="sh">"</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">gmtime</span><span class="p">(</span><span class="n">noon</span><span class="o">*</span><span class="mi">3600</span><span class="p">))</span> <span class="k">for</span> <span class="n">noon</span> <span class="ow">in</span> <span class="n">t_noon</span><span class="p">]</span>
    <span class="n">t_end</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%H:%M:%S</span><span class="sh">"</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">gmtime</span><span class="p">(</span><span class="n">end</span><span class="o">*</span><span class="mi">3600</span><span class="p">))</span> <span class="k">for</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">t_end</span><span class="p">]</span>
    <span class="n">durs</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%H:%M:%S</span><span class="sh">"</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">gmtime</span><span class="p">(</span><span class="n">dur</span><span class="o">*</span><span class="mi">3600</span><span class="p">))</span> <span class="k">for</span> <span class="n">dur</span> <span class="ow">in</span> <span class="n">t</span><span class="p">]</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">dates</span><span class="p">,</span>
                      <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">start</span><span class="sh">'</span><span class="p">:</span><span class="n">t_start</span><span class="p">,</span><span class="sh">'</span><span class="s">noon</span><span class="sh">'</span><span class="p">:</span><span class="n">t_noon</span><span class="p">,</span> <span class="sh">'</span><span class="s">end</span><span class="sh">'</span><span class="p">:</span><span class="n">t_end</span><span class="p">,</span><span class="sh">'</span><span class="s">duration</span><span class="sh">'</span><span class="p">:</span><span class="n">durs</span><span class="p">},</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span><span class="n">df_num</span>

<span class="k">def</span> <span class="nf">mean_fasting_duration</span><span class="p">(</span><span class="n">eot</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">month_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">no_blend</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    given a starting date and a length for the month, the average
    of fasting duration is computated (optionally for a set of 
    coordiantes, otherwise on all latitudes).
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">coords</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
        <span class="n">phis</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">91</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">landas</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros_like</span><span class="p">(</span><span class="n">phis</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="nf">zip</span><span class="p">(</span><span class="n">phis</span><span class="p">,</span> <span class="n">landas</span><span class="p">)</span>
        
    <span class="n">idx_start</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">dates</span><span class="o">==</span><span class="n">start_date</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">idx_end</span> <span class="o">=</span> <span class="n">idx_start</span> <span class="o">+</span> <span class="n">month_length</span> <span class="o">+</span><span class="mi">1</span>
    <span class="n">dates_</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:</span><span class="n">idx_end</span><span class="p">]</span>
    <span class="n">eot_</span> <span class="o">=</span> <span class="n">eot</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:</span><span class="n">idx_end</span><span class="p">]</span>
    
    <span class="n">durations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">for </span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">landa</span><span class="p">)</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span><span class="n">df_num</span> <span class="o">=</span> <span class="nf">find_local_noon</span><span class="p">((</span><span class="n">phi</span><span class="p">,</span><span class="n">landa</span><span class="p">),</span> <span class="n">dates</span><span class="o">=</span><span class="n">dates_</span><span class="p">,</span> <span class="n">eot</span><span class="o">=</span><span class="n">eot_</span><span class="p">,</span> <span class="n">no_blend</span><span class="o">=</span><span class="n">no_blend</span><span class="p">)</span>
        <span class="n">durations</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">df_num</span><span class="p">.</span><span class="n">duration</span><span class="p">.</span><span class="nf">mean</span><span class="p">())</span>
        
    <span class="k">return</span> <span class="n">durations</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">folium</span>
<span class="c1"># obtaining countries coordiantes from open access dats
# https://github.com/mledoze/countries/dist/countries.csv
</span>
<span class="c1"># only latlng is needed for computations. Others are just for either
# vis or later justification.
</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">data/countries.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">cioc</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">cca2</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">cca3</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">latlng</span><span class="sh">'</span><span class="p">,</span>
                                           <span class="sh">'</span><span class="s">area</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">independent</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">flag</span><span class="sh">'</span><span class="p">])</span>

<span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="nf">float</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">float</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">latlng</span><span class="p">]</span>


<span class="c1"># computing mean duration for all countries
</span><span class="n">ramazan_start</span> <span class="o">=</span> <span class="sh">'</span><span class="s">2021-04-13</span><span class="sh">'</span> <span class="c1"># this year..
</span><span class="n">dur_blend</span><span class="o">=</span> <span class="nf">mean_fasting_duration</span><span class="p">(</span><span class="n">eot</span><span class="p">,</span> <span class="n">ramazan_start</span><span class="p">,</span> <span class="n">month_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>
<span class="n">dur_noblend</span><span class="o">=</span> <span class="nf">mean_fasting_duration</span><span class="p">(</span><span class="n">eot</span><span class="p">,</span> <span class="n">ramazan_start</span><span class="p">,</span> <span class="n">month_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">no_blend</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">duration_b</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dur_blend</span>
<span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">duration</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dur_noblend</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># some open access geofiles: either load from url or from hard disk
# geo_data = 'https://datahub.io/core/geo-countries/r/0.geojson'
</span><span class="n">geo_data</span> <span class="o">=</span> <span class="sh">'</span><span class="s">data/countries.geojson</span><span class="sh">'</span>

<span class="n">geo</span><span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">geo_data</span><span class="p">,</span><span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span>
<span class="n">txt</span> <span class="o">=</span> <span class="n">geo</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
<span class="k">del</span> <span class="n">txt</span>
<span class="n">geo</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">style_by_duration</span><span class="p">(</span><span class="n">feature</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="sh">'</span><span class="s">properties</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">ISO_A3</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dur</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">cca3</span><span class="sh">'</span><span class="p">).</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="sh">'</span><span class="s">duration</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
        <span class="n">dur</span> <span class="o">=</span> <span class="bp">None</span>
        
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">fillOpacity</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">weight</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">line_opacity</span><span class="sh">'</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">fillColor</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">#black</span><span class="sh">"</span> <span class="k">if</span> <span class="n">dur</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nf">colorscale</span><span class="p">(</span><span class="n">dur</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">legend_name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Fasting duration (h)</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">caption</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Default model</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">style_by_duration_b</span><span class="p">(</span><span class="n">feature</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="sh">'</span><span class="s">properties</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">ISO_A3</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dur</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">cca3</span><span class="sh">'</span><span class="p">).</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="sh">'</span><span class="s">duration_b</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
        <span class="n">dur</span> <span class="o">=</span> <span class="bp">None</span>
        
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">fillOpacity</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">weight</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">line_opacity</span><span class="sh">'</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">fillColor</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">#black</span><span class="sh">"</span> <span class="k">if</span> <span class="n">dur</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nf">colorscale</span><span class="p">(</span><span class="n">dur</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">legend_name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Fasting duration (h)</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">caption</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Blended model</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">}</span>

<span class="k">def</span> <span class="nf">highlight_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">'</span><span class="s">weight</span><span class="sh">'</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">branca</span>
<span class="n">colorscale</span> <span class="o">=</span> <span class="n">branca</span><span class="p">.</span><span class="n">colormap</span><span class="p">.</span><span class="nc">LinearColormap</span><span class="p">([</span><span class="sh">'</span><span class="s">#479815</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">#2D6CD2</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">#E41E2E</span><span class="sh">'</span><span class="p">],</span> 
                                            <span class="n">vmin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
                                            <span class="n">caption</span><span class="o">=</span><span class="sh">'</span><span class="s">Fasting duration (h)</span><span class="sh">'</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">folium</span><span class="p">.</span><span class="nc">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span><span class="n">zoom_start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">max_bounds</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
               <span class="n">width</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">smooth_factor</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
               <span class="n">crs</span><span class="o">=</span><span class="sh">'</span><span class="s">EPSG3857</span><span class="sh">'</span><span class="p">,</span> <span class="n">tiles</span><span class="o">=</span><span class="sh">'</span><span class="s">cartodb positron</span><span class="sh">'</span><span class="p">)</span>

<span class="n">folium</span><span class="p">.</span><span class="nc">GeoJson</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">style_by_duration</span><span class="p">,</span> <span class="n">highlight_function</span><span class="p">,</span> 
               <span class="n">smooth_factor</span> <span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">Default model</span><span class="sh">"</span><span class="p">,).</span><span class="nf">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="n">folium</span><span class="p">.</span><span class="nc">GeoJson</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">style_by_duration_b</span><span class="p">,</span> <span class="n">highlight_function</span><span class="p">,</span>
               <span class="n">smooth_factor</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">Blended model</span><span class="sh">"</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="nf">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="n">colorscale</span><span class="p">.</span><span class="nf">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">Fasting duration (h)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">folium</span><span class="p">.</span><span class="nc">LayerControl</span><span class="p">().</span><span class="nf">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="n">m</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="sh">'</span><span class="s">duration.html</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="محدودیتها">محدودیت‌ها</h1>
<p>همان طور که قبلا اشاره شد، پارامترهای آزادی در این معیار جدید وجود دارند که بدون پایه‌ی محکم انتخاب شده است. انتخاب تابع وزن خطی، کاملا بر اساس سادگی ریاضیاتی است. هم‌چنین زاویه‌های ساعتی انتخاب شده، هر چند برای شهر مکه هستند، اما لزوما بار مذهبی خاصی ندارند. (عرض جغرافیایی مکه با مکزیکوسیتی و کلکته تقریبا برابر است)!</p>

<p>این پارامترها را می‌توان به بی‌نهایت شکل تغییر داد و به شکل‌های مختلفی رسید. با این حال، هدف من از نگارش این پست، نه پشتیبانی از یک انتخاب خاص، که صرفا مطرح کردن این مدل ادغامی برای محاسبه‌ی زمان اذان در عرض‌های قطبی‌تر بوده است. پارامترهای آزاد باید توسط مراکری (مثل موسسه ژئوفیزیک دانشگاه تهران) تعیین و استانداردسازی شوند.</p>

<p>فارغ از بحث مربوط به پارامترهای آزاد، نحوه‌ی ادغام و حتی، مدل جایگزین (زاویه‌ساعتی-محور) نیز انتخاب‌های یکتایی نیستند. احتمالا روش‌های هوشمندانه‌تری وجود دارند که کاستی‌های روش شرح داده شده را ندارند. خوش‌حال خواهم شد که این ایده‌ها را به صورت نظر با من به اشتراک بگذارید.</p>


      </d-article>

      <d-appendix>
        <d-footnote-list></d-footnote-list>
        <d-citation-list></d-citation-list>
      </d-appendix>

      <d-bibliography src="/assets/bibliography/"></d-bibliography>
</div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        © Copyright 2023 Arash  Golmohammadi. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>.
Last updated: September 21, 2023.
      </div>
    </footer>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article 
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar, 
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible 
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    let navbarHeight = $("#navbar").outerHeight(true);
    $("body").css({ "padding-top": navbarHeight });
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  
</body>
</html>
